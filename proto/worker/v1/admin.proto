syntax = "proto3";

package worker.v1;

option go_package = "github.com/hyp3rd/go-worker/pkg/worker/v1;workerpb";

message GetOverviewRequest {}

message OverviewStats {
  int32 active_workers = 1;
  int64 queued_tasks = 2;
  int32 queues = 3;
  int64 avg_latency_ms = 4;
  int64 p95_latency_ms = 5;
}

message CoordinationStatus {
  string global_rate_limit = 1;
  string leader_lock = 2;
  string lease = 3;
  bool paused = 4;
}

message AdminActionCounters {
  int64 pause = 1;
  int64 resume = 2;
  int64 replay = 3;
}

message GetOverviewResponse {
  OverviewStats stats = 1;
  CoordinationStatus coordination = 2;
  AdminActionCounters actions = 3;
}

message GetHealthRequest {}

message GetHealthResponse {
  string status = 1;
  string version = 2;
  string commit = 3;
  string build_time = 4;
  string go_version = 5;
}

message QueueSummary {
  string name = 1;
  int64 ready = 2;
  int64 processing = 3;
  int64 dead = 4;
  int32 weight = 5;
}

message ListQueuesRequest {}

message ListQueuesResponse {
  repeated QueueSummary queues = 1;
}

message GetQueueRequest {
  string name = 1;
}

message GetQueueResponse {
  QueueSummary queue = 1;
}

message UpdateQueueWeightRequest {
  string name = 1;
  int32 weight = 2;
}

message UpdateQueueWeightResponse {
  QueueSummary queue = 1;
}

message ResetQueueWeightRequest {
  string name = 1;
}

message ResetQueueWeightResponse {
  QueueSummary queue = 1;
}

message ScheduleEntry {
  string name = 1;
  string spec = 2;
  int64 next_run_ms = 3;
  int64 last_run_ms = 4;
  bool durable = 5;
  bool paused = 6;
}

message ScheduleFactory {
  string name = 1;
  bool durable = 2;
}

message ScheduleEvent {
  string task_id = 1;
  string name = 2;
  string spec = 3;
  bool durable = 4;
  string status = 5;
  string queue = 6;
  int64 started_at_ms = 7;
  int64 finished_at_ms = 8;
  int64 duration_ms = 9;
  string result = 10;
  string error = 11;
  map<string, string> metadata = 12;
}

message ListScheduleFactoriesRequest {}

message ListScheduleFactoriesResponse {
  repeated ScheduleFactory factories = 1;
}

message ListScheduleEventsRequest {
  string name = 1;
  int32 limit = 2;
}

message ListScheduleEventsResponse {
  repeated ScheduleEvent events = 1;
}

message ListSchedulesRequest {}

message ListSchedulesResponse {
  repeated ScheduleEntry schedules = 1;
}

message CreateScheduleRequest {
  string name = 1;
  string spec = 2;
  bool durable = 3;
}

message CreateScheduleResponse {
  ScheduleEntry schedule = 1;
}

message DeleteScheduleRequest {
  string name = 1;
}

message DeleteScheduleResponse {
  bool deleted = 1;
}

message PauseScheduleRequest {
  string name = 1;
  bool paused = 2;
}

message PauseScheduleResponse {
  ScheduleEntry schedule = 1;
}

message DLQEntry {
  string id = 1;
  string queue = 2;
  string handler = 3;
  int32 attempts = 4;
  int64 age_ms = 5;
}

message ListDLQRequest {
  int32 limit = 1;
  int32 offset = 2;
  string queue = 3;
  string handler = 4;
  string query = 5;
}

message ListDLQResponse {
  repeated DLQEntry entries = 1;
  int64 total = 2;
}

message PauseDequeueRequest {}

message PauseDequeueResponse {
  bool paused = 1;
}

message ResumeDequeueRequest {}

message ResumeDequeueResponse {
  bool paused = 1;
}

message ReplayDLQRequest {
  int32 limit = 1;
}

message ReplayDLQResponse {
  int32 moved = 1;
}

message ReplayDLQByIDRequest {
  repeated string ids = 1;
}

message ReplayDLQByIDResponse {
  int32 moved = 1;
}

service AdminService {
  rpc GetHealth(GetHealthRequest) returns (GetHealthResponse);
  rpc GetOverview(GetOverviewRequest) returns (GetOverviewResponse);
  rpc ListQueues(ListQueuesRequest) returns (ListQueuesResponse);
  rpc GetQueue(GetQueueRequest) returns (GetQueueResponse);
  rpc UpdateQueueWeight(UpdateQueueWeightRequest) returns (UpdateQueueWeightResponse);
  rpc ResetQueueWeight(ResetQueueWeightRequest) returns (ResetQueueWeightResponse);
  rpc ListScheduleFactories(ListScheduleFactoriesRequest) returns (ListScheduleFactoriesResponse);
  rpc ListScheduleEvents(ListScheduleEventsRequest) returns (ListScheduleEventsResponse);
  rpc ListSchedules(ListSchedulesRequest) returns (ListSchedulesResponse);
  rpc CreateSchedule(CreateScheduleRequest) returns (CreateScheduleResponse);
  rpc DeleteSchedule(DeleteScheduleRequest) returns (DeleteScheduleResponse);
  rpc PauseSchedule(PauseScheduleRequest) returns (PauseScheduleResponse);
  rpc ListDLQ(ListDLQRequest) returns (ListDLQResponse);
  rpc PauseDequeue(PauseDequeueRequest) returns (PauseDequeueResponse);
  rpc ResumeDequeue(ResumeDequeueRequest) returns (ResumeDequeueResponse);
  rpc ReplayDLQ(ReplayDLQRequest) returns (ReplayDLQResponse);
  rpc ReplayDLQByID(ReplayDLQByIDRequest) returns (ReplayDLQByIDResponse);
}
