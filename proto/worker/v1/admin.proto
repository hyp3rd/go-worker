syntax = "proto3";

package worker.v1;

option go_package = "github.com/hyp3rd/go-worker/pkg/worker/v1;workerpb";

message GetOverviewRequest {}

message OverviewStats {
  int32 active_workers = 1;
  int64 queued_tasks = 2;
  int32 queues = 3;
  int64 avg_latency_ms = 4;
  int64 p95_latency_ms = 5;
}

message CoordinationStatus {
  string global_rate_limit = 1;
  string leader_lock = 2;
  string lease = 3;
  bool paused = 4;
}

message AdminActionCounters {
  int64 pause = 1;
  int64 resume = 2;
  int64 replay = 3;
}

message GetOverviewResponse {
  OverviewStats stats = 1;
  CoordinationStatus coordination = 2;
  AdminActionCounters actions = 3;
}

message GetHealthRequest {}

message GetHealthResponse {
  string status = 1;
  string version = 2;
  string commit = 3;
  string build_time = 4;
  string go_version = 5;
}

message QueueSummary {
  string name = 1;
  int64 ready = 2;
  int64 processing = 3;
  int64 dead = 4;
  int32 weight = 5;
  bool paused = 6;
}

message ListQueuesRequest {}

message ListQueuesResponse {
  repeated QueueSummary queues = 1;
}

message GetQueueRequest {
  string name = 1;
}

message GetQueueResponse {
  QueueSummary queue = 1;
}

message UpdateQueueWeightRequest {
  string name = 1;
  int32 weight = 2;
}

message UpdateQueueWeightResponse {
  QueueSummary queue = 1;
}

message ResetQueueWeightRequest {
  string name = 1;
}

message ResetQueueWeightResponse {
  QueueSummary queue = 1;
}

message PauseQueueRequest {
  string name = 1;
  bool paused = 2;
}

message PauseQueueResponse {
  QueueSummary queue = 1;
}

message ScheduleEntry {
  string name = 1;
  string spec = 2;
  int64 next_run_ms = 3;
  int64 last_run_ms = 4;
  bool durable = 5;
  bool paused = 6;
}

message ScheduleFactory {
  string name = 1;
  bool durable = 2;
}

message ScheduleEvent {
  string task_id = 1;
  string name = 2;
  string spec = 3;
  bool durable = 4;
  string status = 5;
  string queue = 6;
  int64 started_at_ms = 7;
  int64 finished_at_ms = 8;
  int64 duration_ms = 9;
  string result = 10;
  string error = 11;
  map<string, string> metadata = 12;
}

message ListScheduleFactoriesRequest {}

message ListScheduleFactoriesResponse {
  repeated ScheduleFactory factories = 1;
}

message ListScheduleEventsRequest {
  string name = 1;
  int32 limit = 2;
}

message ListScheduleEventsResponse {
  repeated ScheduleEvent events = 1;
}

message ListSchedulesRequest {}

message ListSchedulesResponse {
  repeated ScheduleEntry schedules = 1;
}

message CreateScheduleRequest {
  string name = 1;
  string spec = 2;
  bool durable = 3;
}

message CreateScheduleResponse {
  ScheduleEntry schedule = 1;
}

message DeleteScheduleRequest {
  string name = 1;
}

message DeleteScheduleResponse {
  bool deleted = 1;
}

message PauseScheduleRequest {
  string name = 1;
  bool paused = 2;
}

message PauseScheduleResponse {
  ScheduleEntry schedule = 1;
}

message RunScheduleRequest {
  string name = 1;
}

message RunScheduleResponse {
  string task_id = 1;
}

message PauseSchedulesRequest {
  bool paused = 1;
}

message PauseSchedulesResponse {
  int32 updated = 1;
  bool paused = 2;
}

message JobSpec {
  string name = 1;
  string description = 2;
  string repo = 3;
  string tag = 4;
  string path = 5;
  string dockerfile = 6;
  repeated string command = 7;
  repeated string env = 8;
  string queue = 9;
  int32 retries = 10;
  int32 timeout_seconds = 11;
  string source = 12;
  string tarball_url = 13;
  string tarball_path = 14;
  string tarball_sha256 = 15;
}

message Job {
  JobSpec spec = 1;
  int64 created_at_ms = 2;
  int64 updated_at_ms = 3;
}

message JobEvent {
  string task_id = 1;
  string name = 2;
  string status = 3;
  string queue = 4;
  string repo = 5;
  string tag = 6;
  string path = 7;
  string dockerfile = 8;
  string command = 9;
  string schedule_name = 10;
  string schedule_spec = 11;
  int64 started_at_ms = 12;
  int64 finished_at_ms = 13;
  int64 duration_ms = 14;
  string result = 15;
  string error = 16;
  map<string, string> metadata = 17;
}

message ListJobsRequest {}

message ListJobsResponse {
  repeated Job jobs = 1;
}

message ListJobEventsRequest {
  string name = 1;
  int32 limit = 2;
}

message ListJobEventsResponse {
  repeated JobEvent events = 1;
}

message AuditEvent {
  int64 at_ms = 1;
  string actor = 2;
  string request_id = 3;
  string action = 4;
  string target = 5;
  string status = 6;
  string payload_hash = 7;
  string detail = 8;
  map<string, string> metadata = 9;
}

message ListAuditEventsRequest {
  string action = 1;
  string target = 2;
  int32 limit = 3;
}

message ListAuditEventsResponse {
  repeated AuditEvent events = 1;
}

message GetJobRequest {
  string name = 1;
}

message GetJobResponse {
  Job job = 1;
}

message UpsertJobRequest {
  JobSpec spec = 1;
}

message UpsertJobResponse {
  Job job = 1;
}

message DeleteJobRequest {
  string name = 1;
}

message DeleteJobResponse {
  bool deleted = 1;
}

message RunJobRequest {
  string name = 1;
}

message RunJobResponse {
  string task_id = 1;
}

message DLQEntry {
  string id = 1;
  string queue = 2;
  string handler = 3;
  int32 attempts = 4;
  int64 age_ms = 5;
}

message DLQEntryDetail {
  string id = 1;
  string queue = 2;
  string handler = 3;
  int32 attempts = 4;
  int64 age_ms = 5;
  int64 failed_at_ms = 6;
  int64 updated_at_ms = 7;
  string last_error = 8;
  int64 payload_size = 9;
  map<string, string> metadata = 10;
}

message GetDLQEntryRequest {
  string id = 1;
}

message GetDLQEntryResponse {
  DLQEntryDetail entry = 1;
}

message ListDLQRequest {
  int32 limit = 1;
  int32 offset = 2;
  string queue = 3;
  string handler = 4;
  string query = 5;
}

message ListDLQResponse {
  repeated DLQEntry entries = 1;
  int64 total = 2;
}

message PauseDequeueRequest {}

message PauseDequeueResponse {
  bool paused = 1;
}

message ResumeDequeueRequest {}

message ResumeDequeueResponse {
  bool paused = 1;
}

message ReplayDLQRequest {
  int32 limit = 1;
}

message ReplayDLQResponse {
  int32 moved = 1;
}

message ReplayDLQByIDRequest {
  repeated string ids = 1;
}

message ReplayDLQByIDResponse {
  int32 moved = 1;
}

service AdminService {
  rpc GetHealth(GetHealthRequest) returns (GetHealthResponse);
  rpc GetOverview(GetOverviewRequest) returns (GetOverviewResponse);
  rpc ListQueues(ListQueuesRequest) returns (ListQueuesResponse);
  rpc GetQueue(GetQueueRequest) returns (GetQueueResponse);
  rpc UpdateQueueWeight(UpdateQueueWeightRequest) returns (UpdateQueueWeightResponse);
  rpc ResetQueueWeight(ResetQueueWeightRequest) returns (ResetQueueWeightResponse);
  rpc PauseQueue(PauseQueueRequest) returns (PauseQueueResponse);
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);
  rpc ListJobEvents(ListJobEventsRequest) returns (ListJobEventsResponse);
  rpc ListAuditEvents(ListAuditEventsRequest) returns (ListAuditEventsResponse);
  rpc GetJob(GetJobRequest) returns (GetJobResponse);
  rpc UpsertJob(UpsertJobRequest) returns (UpsertJobResponse);
  rpc DeleteJob(DeleteJobRequest) returns (DeleteJobResponse);
  rpc RunJob(RunJobRequest) returns (RunJobResponse);
  rpc ListScheduleFactories(ListScheduleFactoriesRequest) returns (ListScheduleFactoriesResponse);
  rpc ListScheduleEvents(ListScheduleEventsRequest) returns (ListScheduleEventsResponse);
  rpc ListSchedules(ListSchedulesRequest) returns (ListSchedulesResponse);
  rpc CreateSchedule(CreateScheduleRequest) returns (CreateScheduleResponse);
  rpc DeleteSchedule(DeleteScheduleRequest) returns (DeleteScheduleResponse);
  rpc PauseSchedule(PauseScheduleRequest) returns (PauseScheduleResponse);
  rpc RunSchedule(RunScheduleRequest) returns (RunScheduleResponse);
  rpc PauseSchedules(PauseSchedulesRequest) returns (PauseSchedulesResponse);
  rpc ListDLQ(ListDLQRequest) returns (ListDLQResponse);
  rpc GetDLQEntry(GetDLQEntryRequest) returns (GetDLQEntryResponse);
  rpc PauseDequeue(PauseDequeueRequest) returns (PauseDequeueResponse);
  rpc ResumeDequeue(ResumeDequeueRequest) returns (ResumeDequeueResponse);
  rpc ReplayDLQ(ReplayDLQRequest) returns (ReplayDLQResponse);
  rpc ReplayDLQByID(ReplayDLQByIDRequest) returns (ReplayDLQByIDResponse);
}
